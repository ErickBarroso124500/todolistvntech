<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tarefas - TaskFlow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS via CDN for enhanced styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 for better notifications -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Alpine.js for simple reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TaskFlow">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRhc2tGbG93IiwKICAic2hvcnRfbmFtZSI6ICJUYXNrRmxvdyIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzQ2OTcvNDY5NzI2MC5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiM2NjdlZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNEZENTRFNSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0Igp9">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4697/4697260.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4697/4697260.png">
    <style>
        /* Custom Tailwind overrides and additional styles */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --light: #F9FAFB;
            --border: #E5E7EB;
            --text: #374151;
            --text-light: #6B7280;
        }
        body {
            @apply font-sans bg-gradient-to-br from-indigo-400 to-purple-500 min-h-screen text-gray-700;
        }
        .auth-card {
            @apply bg-white p-10 rounded-2xl shadow-xl max-w-md w-full animate-slide-up;
        }
        .btn {
            @apply w-full py-3 px-6 rounded-lg font-semibold cursor-pointer transition-all flex items-center justify-center gap-2;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 hover:-translate-y-px hover:shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-100 text-gray-700 hover:bg-gray-200 mt-3;
        }
        .card {
            @apply bg-white p-6 rounded-2xl shadow-md;
        }
        .task-item {
            @apply p-5 bg-gray-50 rounded-xl border-l-4 transition-all cursor-pointer hover:translate-x-1 hover:shadow-md;
        }
        .task-item.completed {
            @apply opacity-60 border-l-green-500;
        }
        .task-item.completed .task-title {
            @apply line-through;
        }
        .notification {
            @apply fixed top-5 right-5 bg-white p-5 rounded-xl shadow-2xl max-w-sm animate-slide-in z-50 border-l-4 border-indigo-500;
        }
        .empty-state {
            @apply text-center py-10 text-gray-500;
        }
        .empty-state i {
            @apply text-6xl mb-4 opacity-30;
        }
        .tab {
            @apply py-2 px-4 bg-gray-100 rounded-lg cursor-pointer font-semibold text-gray-700 transition-all hover:bg-gray-200;
        }
        .tab.active {
            @apply bg-indigo-600 text-white;
        }
        .loading {
            @apply inline-block w-5 h-5 border-4 border-t-white border-transparent rounded-full animate-spin;
        }
        /* Dark Mode */
        [data-theme="dark"] {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --dark: #F9FAFB;
            --light: #1F2937;
            --text: #D1D5DB;
            --text-light: #9CA3AF;
            --border: #374151;
        }
        [data-theme="dark"] body {
            @apply bg-gradient-to-br from-gray-800 to-gray-900 text-gray-300;
        }
        [data-theme="dark"] .auth-card,
        [data-theme="dark"] .card,
        [data-theme="dark"] .header,
        [data-theme="dark"] .task-item,
        [data-theme="dark"] .notification {
            @apply bg-gray-800 text-gray-300;
        }
        [data-theme="dark"] .task-item {
            @apply bg-gray-700;
        }
        [data-theme="dark"] .tab {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        [data-theme="dark"] .tab.active {
            @apply bg-indigo-500 text-white;
        }
        [data-theme="dark"] .btn-primary {
            @apply bg-indigo-500 hover:bg-indigo-600;
        }
        [data-theme="dark"] .btn-secondary {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body x-data="{ darkMode: localStorage.getItem('darkMode') === 'true', currentFilter: 'pending', searchQuery: '', editingTask: null }" :data-theme="darkMode ? 'dark' : 'light'">
    <!-- PWA Install Button -->
    <button id="installButton" class="fixed bottom-5 right-5 bg-indigo-600 text-white border-none rounded-full w-14 h-14 text-2xl shadow-2xl cursor-pointer z-50 hidden flex items-center justify-center hover:bg-indigo-700 hover:scale-110" title="Instalar TaskFlow">
        <i class="fas fa-download"></i>
    </button>
    <!-- Theme Toggle Button -->
    <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)" class="fixed bottom-5 left-5 bg-indigo-600 text-white border-none rounded-full w-14 h-14 text-2xl shadow-2xl cursor-pointer z-50 flex items-center justify-center hover:bg-indigo-700 hover:scale-110" title="Alternar Tema">
        <i x-show="!darkMode" class="fas fa-moon"></i>
        <i x-show="darkMode" class="fas fa-sun"></i>
    </button>
    <!-- Tela de Login/Cadastro -->
    <div id="authScreen" class="flex justify-center items-center min-h-screen">
        <div class="auth-card">
            <div class="text-center mb-8">
                <h1 class="text-indigo-600 text-3xl mb-2 flex items-center justify-center gap-3"><i class="fas fa-tasks"></i> TaskFlow</h1>
                <p class="text-gray-500 text-sm">Sistema Profissional de Gerenciamento de Tarefas</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label for="username" class="block mb-2 font-medium text-sm">Nome de Usuário</label>
                    <input type="text" id="username" placeholder="Digite seu nome" class="w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all">
                </div>
                <div>
                    <label for="password" class="block mb-2 font-medium text-sm">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" class="w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                <button class="btn btn-secondary" onclick="handleRegister()">
                    <i class="fas fa-user-plus"></i> Criar Conta
                </button>
            </div>
        </div>
    </div>
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard hidden" :class="{ 'block': true }">
        <div class="container max-w-7xl mx-auto p-5">
            <div class="header bg-white p-5 rounded-2xl shadow-md mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl text-gray-800 mb-1">TaskFlow</h1>
                    <p class="text-gray-500 text-sm">Gerencie suas tarefas com eficiência</p>
                </div>
                <div class="flex gap-4 items-center">
                    <span class="user-badge bg-indigo-600 text-white py-2 px-4 rounded-full text-sm font-semibold flex items-center gap-2" id="userBadge">
                        <i class="fas fa-user"></i> <span id="userName"></span>
                    </span>
                    <button class="btn-logout bg-red-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-red-600 transition-all" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
            <div class="main-grid grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Criar/Editar Tarefa -->
                <div id="createTaskCard" class="card col-span-1">
                    <div class="mb-5 flex justify-between items-center border-b-2 pb-4 border-gray-100">
                        <h2 class="text-lg text-gray-800 flex items-center gap-3"><i class="fas fa-plus-circle"></i> <span x-text="editingTask ? 'Editar Tarefa' : 'Nova Tarefa'"></span></h2>
                    </div>
                    <form class="space-y-4" @submit.prevent="editingTask ? updateTask(event) : createTask(event)">
                        <input type="text" class="task-input w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all" id="taskTitle" placeholder="Título da tarefa" required>
                        <textarea class="task-input w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all min-h-[100px] resize-vertical" id="taskDescription" placeholder="Descrição detalhada da tarefa"></textarea>
                        <input type="url" class="task-input w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all" id="taskLink" placeholder="Link (opcional)">
                        <input type="date" class="task-input w-full py-3 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-100 focus:outline-none transition-all" id="taskDueDate" placeholder="Data de vencimento">
                        <div id="adminUserSelect" class="hidden">
                            <label class="block mb-3 font-semibold">Atribuir para:</label>
                            <div class="user-select flex flex-wrap gap-3 p-4 bg-gray-50 rounded-lg" id="userSelect"></div>
                        </div>
                        <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <input type="checkbox" id="taskForMyself" checked @change="toggleAssignmentMode()">
                            <span class="font-medium">Criar tarefa para mim mesmo</span>
                        </label>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> <span x-text="editingTask ? 'Atualizar Tarefa' : 'Criar Tarefa'"></span>
                        </button>
                        <button type="button" class="btn btn-secondary" x-show="editingTask" @click="cancelEdit()">
                            <i class="fas fa-times"></i> Cancelar Edição
                        </button>
                    </form>
                </div>
                <!-- Lista de Tarefas -->
                <div class="card col-span-1 lg:col-span-2">
                    <div class="mb-5 flex justify-between items-center border-b-2 pb-4 border-gray-100">
                        <h2 class="text-lg text-gray-800 flex items-center gap-3"><i class="fas fa-list"></i> Minhas Tarefas</h2>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="tabs flex gap-3">
                            <button class="tab" :class="{ 'active': currentFilter === 'pending' }" @click="currentFilter = 'pending'; filterTasks('pending')">
                                Pendentes
                            </button>
                            <button class="tab" :class="{ 'active': currentFilter === 'completed' }" @click="currentFilter = 'completed'; filterTasks('completed')">
                                Concluídas
                            </button>
                            <button class="tab" :class="{ 'active': currentFilter === 'all' }" @click="currentFilter = 'all'; filterTasks('all')">
                                Todas
                            </button>
                        </div>
                        <input type="text" x-model="searchQuery" @input="searchTasks()" placeholder="Pesquisar tarefas..." class="py-2 px-4 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:outline-none transition-all">
                    </div>
                    <div class="tasks-list space-y-4 max-h-[600px] overflow-y-auto" id="tasksList"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Service Worker Registration & PWA Install -->
    <script>
        // CONFIGURAÇÃO DO SUPABASE
        const SUPABASE_URL = 'https://djxcvgrunadpkzwpxtom.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqeGN2Z3J1bmFkcGt6d3B4dG9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjczOTYsImV4cCI6MjA3ODA0MzM5Nn0.CRTsAj-yIqXJwrx1CGh6dhTjvsgyazHidOseJQwyRpI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let tasksData = []; // Armazenar tarefas para busca e filtro
        let notificationTimeout = null;
        let deferredPrompt;
        // === PWA: Registrar Service Worker ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgdmVyc2lvbiA9IDE7CnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgY29uc3QgdXJsID0gZXZlbnQucmVxdWVzdC51cmw7CiAgaWYgKHVybC5pbmNsdWRlcycvaWNvbi5wbmcpKSB7CiAgICBldmVudC5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkgeHwgZmV0Y2goZXZlbnQucmVxdWVzdCkpfQp9KTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4geyk7')
                    .then(reg => console.log('SW registrado:', reg))
                    .catch(err => console.log('SW erro:', err));
            });
        }
        // === PWA: Capturar evento de instalação ===
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('installButton');
            installBtn.style.display = 'flex';
            installBtn.onclick = () => {
                installBtn.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('PWA instalado');
                    }
                    deferredPrompt = null;
                });
            };
        });
        // Verificar se já está logado
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showDashboard();
        }
        // FUNÇÕES DE AUTENTICAÇÃO
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) {
                showNotification('error', 'Por favor, preencha todos os campos');
                return;
            }
            if (username.toLowerCase() === 'paulo') {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                if (error || !data) {
                    showNotification('error', 'Usuário não encontrado. Por favor, crie uma conta.');
                    return;
                }
                currentUser = {
                    id: data.id,
                    username: data.username,
                    is_admin: true
                };
            } else {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();
                if (error || !data) {
                    showNotification('error', 'Usuário ou senha incorretos');
                    return;
                }
                currentUser = data;
            }
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showDashboard();
            showNotification('success', `Bem-vindo, ${currentUser.username}!`);
        }
        async function handleRegister() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) {
                showNotification('error', 'Por favor, preencha todos os campos');
                return;
            }
            const isAdmin = username.toLowerCase() === 'paulo';
            const { data, error } = await supabase
                .from('users')
                .insert([
                    { username, password, is_admin: isAdmin }
                ])
                .select()
                .single();
            if (error) {
                if (error.code === '23505') {
                    showNotification('error', 'Este usuário já existe');
                } else {
                    showNotification('error', 'Erro ao criar conta: ' + error.message);
                }
                return;
            }
            showNotification('success', 'Conta criada! Faça login agora.');
        }
        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('authScreen').style.display = 'flex';
            showNotification('success', 'Você saiu com sucesso');
        }
        // FUNÇÕES DO DASHBOARD
        async function showDashboard() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userName').textContent = currentUser.username;
            const userBadge = document.getElementById('userBadge');
            if (currentUser.is_admin) {
                userBadge.classList.add('bg-yellow-500');
                userBadge.innerHTML = `<i class="fas fa-crown"></i> ${currentUser.username} (Admin)`;
                document.getElementById('createTaskCard').style.display = 'block';
                await loadUsers();
                toggleAssignmentMode();
            }
            await loadTasks();
            subscribeToChanges();
            requestNotificationPermission();
        }
        async function loadUsers() {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('is_admin', false);
            if (error) {
                console.error('Erro ao carregar usuários:', error);
                return;
            }
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = data.map(user => `
                <label class="user-checkbox flex items-center gap-2 p-3 bg-white border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-indigo-500">
                    <input type="checkbox" value="${user.id}" onchange="toggleUserSelect(this)">
                    <span>${user.username}</span>
                </label>
            `).join('');
        }
        function toggleUserSelect(checkbox) {
            checkbox.parentElement.classList.toggle('bg-indigo-600', checkbox.checked);
            checkbox.parentElement.classList.toggle('text-white', checkbox.checked);
            checkbox.parentElement.classList.toggle('border-indigo-600', checkbox.checked);
        }
        function toggleAssignmentMode() {
            const forMyself = document.getElementById('taskForMyself').checked;
            const adminUserSelect = document.getElementById('adminUserSelect');
            const userCheckboxes = document.querySelectorAll('#userSelect input[type="checkbox"]');
            if (forMyself) {
                adminUserSelect.style.display = 'none';
                userCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                });
            } else {
                adminUserSelect.style.display = 'block';
            }
        }
        async function createTask(event) {
            event.preventDefault();
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const link = document.getElementById('taskLink').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            let finalUsers = [];
            if (document.getElementById('taskForMyself').checked) {
                finalUsers = [currentUser.id];
            } else {
                finalUsers = Array.from(document.querySelectorAll('#userSelect input:checked'))
                    .map(cb => cb.value);
            }
            if (finalUsers.length === 0) {
                showNotification('warning', 'Selecione pelo menos um usuário');
                return;
            }
            const btn = event.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="loading"></span> Criando...';
            btn.disabled = true;
            const tasks = finalUsers.map(userId => ({
                title,
                description,
                link: link || null,
                due_date: dueDate || null,
                assigned_to: userId,
                created_by: currentUser.id,
                completed: false
            }));
            const { error } = await supabase
                .from('tasks')
                .insert(tasks);
            if (error) {
                showNotification('error', 'Erro ao criar tarefa: ' + error.message);
            } else {
                showNotification('success', 'Tarefa criada e enviada!');
                resetTaskForm();
            }
            btn.innerHTML = '<i class="fas fa-save"></i> Criar Tarefa';
            btn.disabled = false;
        }
        async function loadTasks() {
            const { data, error } = await supabase
                .from('tasks')
                .select(`
                    *,
                    assigned_user:users!tasks_assigned_to_fkey(username),
                    creator:users!tasks_created_by_fkey(username)
                `)
                .or(`assigned_to.eq.${currentUser.id},created_by.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });
            if (error) {
                console.error('Erro ao carregar tarefas:', error);
                return;
            }
            tasksData = data;
            displayTasks(data);
        }
        function displayTasks(tasks) {
            const currentFilter = Alpine.store('app')?.currentFilter || 'pending';
            const searchQuery = Alpine.store('app')?.searchQuery?.toLowerCase() || '';
            const filtered = tasks.filter(task => {
                const matchesFilter = 
                    currentFilter === 'pending' ? !task.completed :
                    currentFilter === 'completed' ? task.completed :
                    true;
                const matchesSearch = 
                    task.title.toLowerCase().includes(searchQuery) ||
                    (task.description && task.description.toLowerCase().includes(searchQuery)) ||
                    (task.assigned_user?.username.toLowerCase().includes(searchQuery)) ||
                    (task.creator?.username.toLowerCase().includes(searchQuery));
                return matchesFilter && matchesSearch;
            });
            const tasksList = document.getElementById('tasksList');
            if (filtered.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Nenhuma tarefa encontrada</p>
                    </div>
                `;
                return;
            }
            tasksList.innerHTML = filtered.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''} border-l-indigo-500">
                    <div class="flex justify-between items-start mb-3">
                        <div class="task-title font-semibold text-gray-800 text-base">${task.title}</div>
                        <span class="task-status py-1 px-3 rounded-full text-xs font-semibold ${task.completed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${task.completed ? 'Concluída' : 'Pendente'}
                        </span>
                    </div>
                    ${task.description ? `<div class="task-description text-gray-500 text-sm mb-3 line-clamp-3">${task.description}</div>` : ''}
                    ${task.link ? `<a href="${task.link}" class="task-link block mb-2 text-sm text-indigo-600 underline hover:text-indigo-800" target="_blank" rel="noopener">Acessar Link</a>` : ''}
                    ${task.due_date ? `<div class="text-sm text-gray-500 mb-2"><i class="fas fa-calendar-check"></i> Vencimento: ${new Date(task.due_date).toLocaleDateString('pt-BR')}</div>` : ''}
                    <div class="task-meta flex gap-4 text-xs text-gray-500">
                        <span><i class="fas fa-user"></i> ${task.assigned_user?.username || 'N/A'}</span>
                        <span><i class="fas fa-user-plus"></i> Criado por: ${task.creator?.username || 'N/A'}</span>
                        <span><i class="fas fa-calendar"></i> ${new Date(task.created_at).toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button onclick="toggleTaskCompletion('${task.id}', ${task.completed})" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button onclick="editTask('${task.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        async function toggleTaskCompletion(taskId, isCompleted) {
            const newStatus = !isCompleted;
            const { data, error } = await supabase
                .from('tasks')
                .update({ completed: newStatus })
                .eq('id', taskId)
                .select(`
                    *,
                    assigned_user:users!tasks_assigned_to_fkey(username),
                    creator:users!tasks_created_by_fkey(username, id)
                `)
                .single();
            if (error) {
                showNotification('error', 'Erro ao atualizar tarefa');
                return;
            }
            const action = newStatus ? 'concluída' : 'reaberta';
            showNotification('success', `Tarefa ${action} com sucesso!`);
            if (currentUser.id !== data.creator.id && newStatus) {
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: data.creator.id,
                        message: `${currentUser.username} concluiu a tarefa: "${data.title}"`,
                        task_id: taskId
                    });
            }
            loadTasks();
        }
        async function editTask(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (!task) return;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskLink').value = task.link || '';
            document.getElementById('taskDueDate').value = task.due_date || '';
            // Para admins, selecionar usuários atribuídos (simplificado para single assign por agora)
            if (currentUser.is_admin && task.assigned_to !== currentUser.id) {
                document.getElementById('taskForMyself').checked = false;
                toggleAssignmentMode();
                const checkboxes = document.querySelectorAll('#userSelect input');
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === task.assigned_to;
                    toggleUserSelect(cb);
                });
            } else {
                document.getElementById('taskForMyself').checked = true;
                toggleAssignmentMode();
            }
            Alpine.store('app').editingTask = task;
            document.querySelector('#createTaskCard h2 span').textContent = 'Editar Tarefa';
        }
        async function updateTask(event) {
            event.preventDefault();
            const editingTask = Alpine.store('app').editingTask;
            if (!editingTask) return;
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const link = document.getElementById('taskLink').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            let assignedTo = editingTask.assigned_to;
            if (!document.getElementById('taskForMyself').checked) {
                const selected = document.querySelector('#userSelect input:checked');
                if (selected) assignedTo = selected.value;
            }
            const btn = event.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="loading"></span> Atualizando...';
            btn.disabled = true;
            const { error } = await supabase
                .from('tasks')
                .update({
                    title,
                    description,
                    link: link || null,
                    due_date: dueDate || null,
                    assigned_to: assignedTo
                })
                .eq('id', editingTask.id);
            if (error) {
                showNotification('error', 'Erro ao atualizar tarefa: ' + error.message);
            } else {
                showNotification('success', 'Tarefa atualizada!');
                resetTaskForm();
                Alpine.store('app').editingTask = null;
            }
            btn.innerHTML = '<i class="fas fa-save"></i> Atualizar Tarefa';
            btn.disabled = false;
        }
        function cancelEdit() {
            resetTaskForm();
            Alpine.store('app').editingTask = null;
        }
        async function deleteTask(taskId) {
            const confirm = await Swal.fire({
                title: 'Confirmar exclusão?',
                text: 'Esta ação não pode ser desfeita.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Excluir',
                cancelButtonText: 'Cancelar'
            });
            if (!confirm.isConfirmed) return;
            const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', taskId);
            if (error) {
                showNotification('error', 'Erro ao excluir tarefa');
            } else {
                showNotification('success', 'Tarefa excluída!');
                loadTasks();
            }
        }
        function resetTaskForm() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskLink').value = '';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskForMyself').checked = true;
            toggleAssignmentMode();
        }
        function filterTasks(filter) {
            displayTasks(tasksData);
        }
        function searchTasks() {
            displayTasks(tasksData);
        }
        // === NOTIFICAÇÕES EM TEMPO REAL + PUSH (PWA) ===
        function subscribeToChanges() {
            supabase
                .channel('tasks')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'tasks',
                        filter: `assigned_to=eq.${currentUser.id}`
                    },
                    (payload) => {
                        loadTasks();
                    }
                )
                .subscribe();
            supabase
                .channel('notifications')
                .on('postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'notifications',
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        showNotification('info', payload.new.message);
                        supabase
                            .from('notifications')
                            .update({ read: true })
                            .eq('id', payload.new.id)
                            .then(() => {});
                    }
                )
                .subscribe();
        }
        function showNotification(type, message) {
            Swal.fire({
                icon: type,
                title: type.charAt(0).toUpperCase() + type.slice(1),
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
            // Notificação nativa
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(type.charAt(0).toUpperCase() + type.slice(1), {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/4697/4697260.png'
                });
            }
        }
        // === SOLICITAR PERMISSÃO DE NOTIFICAÇÃO ===
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notificações permitidas');
                    }
                });
            }
        }
        if ('Notification' in window && Notification.permission === 'default') {
            requestNotificationPermission();
        }
        // Inicializar Alpine store
        document.addEventListener('alpine:init', () => {
            Alpine.store('app', {
                currentFilter: 'pending',
                searchQuery: '',
                editingTask: null
            });
        });
    </script>
</body>
</html>
